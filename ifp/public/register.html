<!DOCTYPE html>
<html lang="pl">
    <head>
        <meta charset="UTF-8">
        <title id="title">ifp</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="favicon.ico" rel="shortcut icon">
        <link href="/lib/wwli-res.css" rel="stylesheet">
        <link href="/lib/wwli-nav.css" rel="stylesheet">
        <link href="/lib/wwli-class.css" rel="stylesheet">
        <link href="style.css" rel="stylesheet">

        <style>
            form{
                --hei: 430px;
                height: var(--hei);
                margin-top: calc(43vh - var(--hei) / 2 );
                background-color: #222;
                border-radius: 20px;
                padding-top: 18px;
            }
            input{
                width: 60%;
                height: 2rem;
                margin: 8px;
                border-radius: 6px;
                padding: 5px;
            }
            button{
                width: 50%;
                height: 2.2rem;
                margin: 4px;
            }
            #err{
                height: 1.5rem;
                margin: 8px;
            }
            .napis{
                color: aqua;
                font-size: 1.1rem;
            }
            #passGood{
                font: 1.1rem;
            }
            .passGood{
                width: 7.5rem;
                text-align: left;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <noscript>Ta strona wymaga js (javascript) do poprawnego działania</noscript>
            <form id="form" class="s m_6 l_4 mar">
                <span class="napis">Login:</span>
                <br />
                <input type="text" id="login" name="login">
                <br />
                <span class="napis">Email:</span>
                <br />
                <input type="email" id="email" name="email">
                <br />
                <span class="napis">Hasło:</span>
                <br />
                <input type="password" id="pass1" name="password">
                <br />
                <a href="javascript:void(0)" onclick="pokazPass(1)">Pokaż Hasło</a>
                <br />
                <span class="napis">Hasło:</span>
                <br />
                <input type="password" id="pass2" name="password2">
                <br />
                <a href="javascript:void(0)" onclick="pokazPass(2)">Pokaż Hasło</a>
                <br />
                <div id="err"></div>
                <button type="submit" value="">OK</button>
            </form>
            <div id="passGood">
                <div class="passGood mar"><span id="passGood_a"></span> Mała litera</div>
                <div class="passGood mar"><span id="passGood_A"></span> Duża litera</div>
                <div class="passGood mar"><span id="passGood_1"></span> Liczba</div>
                <div class="passGood mar"><span id="passGood_$"></span> Znak specialny</div>
                <div class="passGood mar"><span id="passGood_len"></span> 8 znaków</div>
            </div>
        </div>

        <script src="/lib/wwli.js"></script>
        <script>
            var loginDiv = __("#login");
            var emailDiv = __("#email");
            var pass1Div = __("#pass1");
            var pass2Div = __("#pass2");
            var errDiv = __("#err");

            var passGood_a = __("#passGood_a");
            var passGood_A = __("#passGood_A");
            var passGood_1 = __("#passGood_1");
            var passGood_$ = __("#passGood_$");
            var passGood_len = __("#passGood_len");

            __("#form").on("submit", async (e) => {
                e.preventDefault();
                var login = loginDiv.cont();
                if(!login){
                    errDiv.html("Pole Login nie może być pusty");
                    return;
                }
                if(!/^[a-zA-Z0-9]+$/.test(login)){
                    errDiv.html("Login może zawierać tylko duże i małe litery oraz cyfry");
                    return;
                }
                login = login.trim();
                if(login.length < 3 || login.length > 10){
                    errDiv.html("Login musi mieć od 3 do 10 znaków");
                    return;
                }
                var email = emailDiv.cont();
                if(!email){
                    errDiv.html("Pole Email nie może być pusty");
                    return;
                }
                email = email.trim();

                var pass1 = pass1Div.cont();
                if(!pass1){
                    errDiv.html("Pole Hasło nie może być puste");
                    return;
                }
                pass1 = pass1.trim();
                var pass2 = pass2Div.cont();
                if(!pass2){
                    errDiv.html("Pole Hasło nie może być puste");
                    return;
                }
                pass2 = pass2.trim();

                if(pass1 != pass2){
                    errDiv.html("Hasła muszą być takie same");
                    return;
                }

                if(!vaildPass(pass1)) return;

                // var keys = await generateRSAKeyPair();
                // keys = JSON.stringify(keys)

                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/register", false);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({ name: login, password: pass1, email }));
                var res = JSON.parse(xhr.responseText);
                if(res.err){
                    errDiv.html(res.msg);
                    return;
                }
                location.href = "/register-kod";
            });

            function vaildPass(pass){
                if(!pass.match(/[a-z]/g)){
                    errDiv.html("Hasło musi zawairać <b>małą</b> literę.");
                    return false;
                }
                if(!pass.match(/[A-Z]/g)){
                    errDiv.html("Hasło musi zawairać <b>dużą</b> literę.");
                    return false;
                }
                if(!pass.match(/[0-9]/g)){
                    errDiv.html("Hasło musi zawairać <b>cyfrę</b>.");
                    return false;
                }
                if(!pass.match(/[-!$%^&*()_+|~=`{}\[\]:\/;<>?,.@#]/)){
                    errDiv.html("Hasło musi zawairać <b>znak specjalny</b>.");
                    return false;
                }
                if(pass.length < 8){
                    errDiv.html("Hasło musi musi mieć przynajmniej <b>8 znaków</b>.");
                    return false;
                }
                if(pass.length > 300){
                    errDiv.html("Hasło musi musi mieć mniej niż <b>300 znaków</b>.");
                    return false;
                }
                return true;
            }

            function pokazPass(x){
                var pass = window["pass"+x+"Div"];
                if(!pass) return;
                pass = pass.g();
                if(pass.type == "text"){
                    pass.type = "password";
                }else{
                    pass.type = "text";
                }
            }

            function xv(v){
                if(v) return "<span style=\"color: green\">V</span>";
                else return "<span style=\"color: red\">X</span>";
            }

            function passGood(){
                var pass = pass1Div.cont();
                passGood_a.html(xv(pass.match(/[a-z]/g)));
                passGood_A.html(xv(pass.match(/[A-Z]/g)));
                passGood_1.html(xv(pass.match(/[0-9]/g)));
                passGood_$.html(xv(pass.match(/[-!$%^&*()_+|~=`{}\[\]:\/;<>?,.@#]/)));
                passGood_len.html(xv(pass.length >= 8));
            }
            passGood();
            pass1Div.on("input", passGood);

            async function generateRSAKeyPair(){
                return { publicKey: "1", privateKey: "1" }
            }
        </script>
    </body>
</html>