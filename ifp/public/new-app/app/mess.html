<div class="left" id="messagess">
    <div id="msg"></div>
    <div id="send" style="display: none;">
        <span id="pisze"></span>
        <br />
        <div id="send-menu" class="mar">
            <input type="text" id="inpSend">
            <div id="send-menu-data">
                <span style="cursor: pointer;" onclick="emocjiMenu()" id="emocjiMenuM">ðŸ¦†</span>
                &nbsp;
                <span style="cursor: pointer; color: green; font-size: 2rem;" onclick="sendFile()">+</span>
            </div>
            <button onclick="sendMess()" disabled>
                <span loadUrl="/img/send.svg"></span>
            </button>
        </div>
    </div>
</div>

<script>

const msgInput = document.querySelector("#inpSend");
const msgDiv = document.querySelector("#msg");
const sendDiv = document.querySelector("#send");

function sendMess(){
    if(toChat == localUser.id) return uiMsg("nie moÅ¼esz wysÅ‚aÄ‡ wiadomoÅ›ci do siebie", 1);
    if(toChat == "main") return uiMsg("main", 1);

    let msg = msgInput.value.trim();
    if(!msg) return;

    let silent = false;
    if(msg.startsWith("/silent ")){
        silent = true;
        msg = msg.replace("/silent ");
    }

    if(msg.length > 90) return uiMsg("msg jest za dÅ‚ugie", 1);

    let data = {
        from: localUser.id,
        to: toChat,
        msg,
        channel: "main",
        res: resMsgId ? resMsgId : "",
        silent
    }

    socket.emit("mess", data);
    msgInput.value = "";
    focusInp();
    sendBtnStyle();
}

function loadMoreMess(){
    let tmp = actMess;
    actMess += messCount;
    if(toChat != "main") socket.emit("getMessage", toChat, tmp, actMess, true);
}

function addMess(msg, socroll=true, up=false){
    var from = changeIdToName(msg.from);
    var div = document.createElement("div");
    if(utils.ss()){ //if mobile
        div.addEventListener("dblclick", (e) => contMenu.mess(from == localUser.fr, msg._id, e));
    }else{
        div.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            contMenu.mess(from == localUser.fr, msg._id, e);
            return false;
        });
    }
    div.classList.add("mess");
    div.setAttribute("_id", msg._id);

    let content = msg.msg;
    if(msg.res){
        setTimeout(() => responeMess(div, msg.res), 1000);
    }
    content = formatText(content);
    if(msg.e) content += edit_txt;
    div.innerHTML = 
        `<div><b>${from}</b></div>`+
        `<div id="${msg._id}_mess" _plain="${msg.msg}">${content}</div>`;
    
    up ? msgDiv.addUp(div) : msgDiv.add(div);

    if(socroll && msgDiv.scrollTop >= msgDiv.scrollHeight - msgDiv.clientHeight - 20){
        div.scrollIntoView({behavior: "smooth"});
    }
}

function sendBtnStyle(){
    var len = msgInput.value.trim().length;
    var prop = "";
    if(len == 0) prop = "grey";
    else if(len <= 90) prop = "green";
    else if(len > 90) prop = "red";
    document.querySelector("#sendBtn-img").style.setProperty("--fil", prop);
    document.querySelector("#send-menu button").disabled = len == 0;
}

msgInput.on("input", () => {
    [
        // function(){
        //     if(isType) return;
        //     if(inpSendDiv.cont() == "") return;
        //     isType = true;
        //     socket.emit("type", to);
        //     setTimeout(() => {
        //         isType = false;
        //     }, 5000);
        // },
        // function(){
        //     inpSendDiv.value(changeEmo(inpSendDiv.value()));
        // },
        sendBtnStyle
    ].forEach(e=>e());
});

msgInput.on("keypress", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMess();
    }
});

function linkClick(e){
    e.preventDefault();
    var link = e.target.href;
    document.querySelector("#alertLinkSpan").html(link);
    var e = document.querySelector("#alertLink");
    e.css("");
    e.fadeIn();
}

function hideLink(){
    document.querySelector("#alertLink").fadeOut();
}

document.querySelector("#alertLink_ok").on("click", () => {
    hideLink();
    window.open(document.querySelector("#alertLinkSpan").html(), "_blank");
});

function reloadMsg(time){
    function f(){
        msgDiv.html("");
        socket.emit("getMessage", to, 0, messCount, false);
    }
    time ? setTimeout(f, time*1000) : f();
}

function emocjiMenu(){
    var e = document.querySelector("#emocjiMenu");
    e.css("");
    animateFade(e, 0);

    var del = () => {
        animateFade(e, 1, 300);
        setTimeout(() => e.style.display = "none", 700);
        document.removeEventListener("click", del);
    }
    setTimeout(() => {
        document.addEventListener("click", del);
    }, 1000);
}

function focusInp(){
    if(cw.ss()) return;
    setTimeout(() => {
        msgInput.focus();
    }, 100);
}

</script>